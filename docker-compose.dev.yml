services:
  lora-pilot:
    image: ${LORA_PILOT_IMAGE:-notrius/lora-pilot:latest}
    container_name: ${LORA_PILOT_CONTAINER_NAME:-lora-pilot-dev}
    restart: unless-stopped
    
    # GPU support
    runtime: nvidia
    environment:
      # GPU configuration
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-compute,utility,display}
      
      # Timezone
      - TZ=${TZ:-America/New_York}
      - HF_TOKEN=${HF_TOKEN:-}
      - SUPERVISOR_ADMIN_PASSWORD=${SUPERVISOR_ADMIN_PASSWORD:-}
      
      # Development mode settings
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - FLASK_ENV=${FLASK_ENV:-development}
      # Enable debug features
      - DEBUG=${DEBUG:-1}
      - PORTAL_PORT=${PORTAL_PORT:-7878}
      - JUPYTER_PORT=${JUPYTER_PORT:-8888}
      - CODE_SERVER_PORT=${CODE_SERVER_PORT:-8443}
      - COMFY_PORT=${COMFY_PORT:-5555}
      - KOHYA_PORT=${KOHYA_PORT:-6666}
      - INVOKE_PORT=${INVOKE_PORT:-9090}
      - DIFFPIPE_PORT=${DIFFPIPE_PORT:-4444}
      - AI_TOOLKIT_PORT=${AI_TOOLKIT_PORT:-8675}
      - AI_TOOLKIT_DB_PATH=${AI_TOOLKIT_DB_PATH:-/workspace/config/ai-toolkit/aitk_db.db}
      - COPILOT_SIDECAR_PORT=${COPILOT_SIDECAR_PORT:-7879}
      - COPILOT_SIDECAR_URL=${COPILOT_SIDECAR_URL:-http://127.0.0.1:7879}
      - COPILOT_GITHUB_TOKEN=${COPILOT_GITHUB_TOKEN:-}
      - COPILOT_HOME=${COPILOT_HOME:-/workspace/home/root}
      - COPILOT_XDG_CONFIG_HOME=${COPILOT_XDG_CONFIG_HOME:-/workspace/home/root/.config}
      - COPILOT_CWD=${COPILOT_CWD:-/workspace}
      - COPILOT_TIMEOUT_SECONDS=${COPILOT_TIMEOUT_SECONDS:-1800}
    
    ports:
      - "${PORTAL_PORT:-7878}:${PORTAL_PORT:-7878}"
      - "${JUPYTER_PORT:-8888}:${JUPYTER_PORT:-8888}"
      - "${CODE_SERVER_PORT:-8443}:${CODE_SERVER_PORT:-8443}"
      - "${COMFY_PORT:-5555}:${COMFY_PORT:-5555}"
      - "${KOHYA_PORT:-6666}:${KOHYA_PORT:-6666}"
      - "${INVOKE_PORT:-9090}:${INVOKE_PORT:-9090}"
      - "${DIFFPIPE_PORT:-4444}:${DIFFPIPE_PORT:-4444}"
      - "${AI_TOOLKIT_PORT:-8675}:${AI_TOOLKIT_PORT:-8675}"
    
    volumes:
      # Development workspace
      - ./workspace:/workspace
      # Mount source code for development (optional)
      - ./apps/Portal:/opt/pilot/apps/Portal
      - ./apps/MediaPilot:/opt/pilot/apps/MediaPilot
      # Mount scripts for development without masking /opt/pilot/repos from the image
      - ./scripts:/opt/pilot/scripts
      - ./scripts/bootstrap.sh:/opt/pilot/bootstrap.sh
      - ./scripts/gpu-smoke-test.sh:/opt/pilot/gpu-smoke-test.sh
      - ./scripts/start-jupyter.sh:/opt/pilot/start-jupyter.sh
      - ./scripts/start-code-server.sh:/opt/pilot/start-code-server.sh
      - ./scripts/comfy.sh:/opt/pilot/comfy.sh
      - ./scripts/start-kohya.sh:/opt/pilot/start-kohya.sh
      - ./scripts/kohya.sh:/opt/pilot/kohya.sh
      - ./scripts/diffusion-pipe.sh:/opt/pilot/diffusion-pipe.sh
      - ./scripts/invoke.sh:/opt/pilot/invoke.sh
      - ./scripts/tagpilot.sh:/opt/pilot/tagpilot.sh
      - ./scripts/portal.sh:/opt/pilot/portal.sh
      - ./scripts/copilot-sidecar.sh:/opt/pilot/copilot-sidecar.sh
      - ./scripts/get-models.sh:/opt/pilot/get-models.sh
      - ./scripts/get-modelsgui.sh:/opt/pilot/get-modelsgui.sh
      # Mount supervisor config (optional)
      - ./supervisor:/etc/supervisor
    
    # Override entrypoint for development
    entrypoint: ["/usr/bin/tini", "-s", "--"]
    command: ["/bin/bash", "-lc", "/opt/pilot/bootstrap.sh && exec /usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf"]
    
    # Keep container running for debugging
    stdin_open: true
    tty: true

networks:
  default:
    name: ${LORA_PILOT_NETWORK_NAME:-lora-pilot-dev-network}
