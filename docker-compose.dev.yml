version: '3.8'

services:
  lora-pilot:
    image: notrius/lora-pilot:latest
    container_name: lora-pilot-dev
    restart: unless-stopped
    
    # GPU support
    runtime: nvidia
    environment:
      # GPU configuration
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,display
      
      # Timezone
      - TZ=America/New_York
      
      # Development mode settings
      - PYTHONUNBUFFERED=1
      - FLASK_ENV=development
      # Enable debug features
      - DEBUG=1
    
    ports:
      - "7878:7878"
      - "8888:8888"
      - "8443:8443"
      - "5555:5555"
      - "6666:6666"
      - "9090:9090"
      - "4444:4444"
      - "8675:8675"
    
    volumes:
      # Development workspace
      - ./workspace:/workspace
      # Mount source code for development (optional)
      - ./apps/Portal:/opt/pilot/apps/Portal
      # Mount scripts for development without masking /opt/pilot/repos from the image
      - ./scripts:/opt/pilot/scripts
      - ./scripts/bootstrap.sh:/opt/pilot/bootstrap.sh
      - ./scripts/gpu-smoke-test.sh:/opt/pilot/gpu-smoke-test.sh
      - ./scripts/start-jupyter.sh:/opt/pilot/start-jupyter.sh
      - ./scripts/start-code-server.sh:/opt/pilot/start-code-server.sh
      - ./scripts/comfy.sh:/opt/pilot/comfy.sh
      - ./scripts/start-kohya.sh:/opt/pilot/start-kohya.sh
      - ./scripts/kohya.sh:/opt/pilot/kohya.sh
      - ./scripts/diffusion-pipe.sh:/opt/pilot/diffusion-pipe.sh
      - ./scripts/invoke.sh:/opt/pilot/invoke.sh
      - ./scripts/tagpilot.sh:/opt/pilot/tagpilot.sh
      - ./scripts/portal.sh:/opt/pilot/portal.sh
      - ./scripts/copilot-sidecar.sh:/opt/pilot/copilot-sidecar.sh
      - ./scripts/get-models.sh:/opt/pilot/get-models.sh
      - ./scripts/get-modelsgui.sh:/opt/pilot/get-modelsgui.sh
      # Mount supervisor config (optional)
      - ./supervisor:/etc/supervisor
    
    # Override entrypoint for development
    entrypoint: ["/usr/bin/tini", "-s", "--"]
    command: ["/bin/bash", "-lc", "/opt/pilot/bootstrap.sh && exec /usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf"]
    
    # Keep container running for debugging
    stdin_open: true
    tty: true

networks:
  default:
    name: lora-pilot-dev-network
