services:
  lora-pilot:
    image: ${LORA_PILOT_IMAGE:-notrius/lora-pilot:latest}
    container_name: ${LORA_PILOT_CONTAINER_NAME:-lora-pilot-minimal}
    restart: unless-stopped
    
    # NO GPU - CPU only mode
    # Note: Resource limits via 'deploy' are ignored by local Docker Compose
    # Use Docker daemon limits or external orchestration for production resource control
    
    ports:
      # Only essential ports
      - "${PORTAL_PORT:-7878}:${PORTAL_PORT:-7878}"  # ControlPilot
      - "${JUPYTER_PORT:-8888}:${JUPYTER_PORT:-8888}"  # JupyterLab
      - "${AI_TOOLKIT_PORT:-8675}:${AI_TOOLKIT_PORT:-8675}"  # AI Toolkit UI
    
    volumes:
      - ./workspace:/workspace
    
    environment:
      - TZ=${TZ:-America/New_York}
      - PORTAL_PORT=${PORTAL_PORT:-7878}
      - JUPYTER_PORT=${JUPYTER_PORT:-8888}
      - AI_TOOLKIT_PORT=${AI_TOOLKIT_PORT:-8675}
      - AI_TOOLKIT_DB_PATH=${AI_TOOLKIT_DB_PATH:-/workspace/config/ai-toolkit/aitk_db.db}
      - HF_TOKEN=${HF_TOKEN:-}
      - SUPERVISOR_ADMIN_PASSWORD=${SUPERVISOR_ADMIN_PASSWORD:-}
      - COPILOT_SIDECAR_PORT=${COPILOT_SIDECAR_PORT:-7879}
      - COPILOT_SIDECAR_URL=${COPILOT_SIDECAR_URL:-http://127.0.0.1:7879}
      - COPILOT_GITHUB_TOKEN=${COPILOT_GITHUB_TOKEN:-}
      - COPILOT_HOME=${COPILOT_HOME:-/workspace/home/root}
      - COPILOT_XDG_CONFIG_HOME=${COPILOT_XDG_CONFIG_HOME:-/workspace/home/root/.config}
      - COPILOT_CWD=${COPILOT_CWD:-/workspace}
      - COPILOT_TIMEOUT_SECONDS=${COPILOT_TIMEOUT_SECONDS:-1800}
      # CPU-only optimizations
      - OMP_NUM_THREADS=${OMP_NUM_THREADS:-4}
      - MKL_NUM_THREADS=${MKL_NUM_THREADS:-4}

networks:
  default:
    name: ${LORA_PILOT_NETWORK_NAME:-lora-pilot-minimal-network}
