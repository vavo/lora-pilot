<style>
  .tp-datasets-link {
    font-size: 13px;
  }

  .tp-select {
    min-height: 42px;
    font-size: 14px;
  }

  .tp-epoch-example {
    margin-top: 6px;
    font-size: 12px;
    color: var(--muted);
  }

  .tp-training-indicator {
    margin-left: 10px;
    align-items: center;
  }
  .tp-training-indicator:not(.is-hidden) {
    display: inline-flex;
  }

  .tp-active-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #10b981;
    border-radius: 50%;
    margin-right: 6px;
    animation: pulse 2s infinite;
  }

  .tp-active-text {
    color: #10b981;
    font-size: 13px;
  }

  .tp-actions .btn.danger {
    background: #dc2626;
    color: #fff;
    border-color: #dc2626;
  }

  .tp-primary-panel {
    border-color: rgba(255, 90, 62, 0.65);
  }
</style>
<div class="page-hero">
  <img src="/logo-trainpilot.svg" alt="TrainPilot" class="page-hero-logo">
</div>
<h2 class="section-title-tight">Train with kohya</h2>
<div class="card">
  <div class="grid-2">
    <div class="panel stack-md tp-primary-panel">
      <h4>1. Choose dataset</h4>
      <div>
        <select id="tp-dataset" class="select tp-select"></select>
        <div class="mt-6">
          <a href="#" class="link-accent tp-datasets-link" onclick="openDatasets(event)">add new dataset</a><br>
        </div>
      </div>
      <div class="field">
        <label>Output name (this will be the name of your LoRA epochs)</label>
        <input id="tp-output" class="input" type="text" placeholder="output name" />
        <div id="tp-epoch-example" class="tp-epoch-example">Example epoch name: output_name000001.safetensors</div>
      </div>

      <h4 class="mt-16">2. Choose output quality</h4>
      <select id="tp-profile" class="select tp-select">
        <option value="quick_test" selected>Quick test (400-600 steps)</option>
        <option value="regular">Normal quality (800-1200 steps)</option>
        <option value="high_quality">High quality (1600-2400 steps)</option>
      </select>
    </div>
  </div>
  <div class="row wrap mt-14 tp-actions">
    <button class="btn primary" onclick="startTrainPilot()">Start</button>
    <button class="btn danger" onclick="stopTrainPilot()">Stop</button>
    <span id="tp-status" class="status"></span>
    <div id="tp-progress-wrap" class="tp-progress-wrap is-hidden">
      <div class="tp-progress">
        <div id="tp-progress-bar" class="tp-progress-bar"></div>
      </div>
      <span id="tp-progress-text" class="tp-progress-text"></span>
    </div>
    <div id="tp-modeldl-wrap" class="tp-progress-wrap is-hidden">
      <div class="tp-progress">
        <div id="tp-modeldl-bar" class="tp-progress-bar"></div>
      </div>
      <span id="tp-modeldl-text" class="tp-progress-text"></span>
    </div>
    <span id="tp-training-indicator" class="tp-training-indicator is-hidden">
      <span class="tp-active-dot"></span>
      <span class="tp-active-text">Training Active</span>
    </span>
  </div>
  <div class="panel mt-12">
    <h3>TOML Config</h3><br>
    <code id="toml-config-path" class="link-accent code-link" onclick="showTomlConfig()">/workspace/apps/TrainPilot/newlora.toml</code>
    <div class="mt-8 text-12 muted">
      Click to preview the current training configuration
    </div>
  </div>
  <div class="panel mt-12">
    <h3>Training Logs</h3>
    <div class="mb-8 text-12 muted">
      Shows TrainPilot process logs + Kohya training output from <code>/workspace/outputs/*/_logs/train.log</code>
    </div>
    <pre id="tp-logs" class="log-box mono mono-sm"></pre>
  </div>
 </div>
  
  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .tp-progress-wrap {
      align-items: center;
      gap: 8px;
      margin-left: 6px;
    }
    .tp-progress-wrap:not(.is-hidden) {
      display: inline-flex;
    }

    .tp-progress {
      width: 180px;
      height: 10px;
      background: var(--border);
      border-radius: 999px;
      overflow: hidden;
    }

    .tp-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), #10b981);
      transition: width 0.2s ease-out;
    }

    .tp-progress-text {
      font-size: 12px;
      color: var(--muted);
      min-width: 90px;
    }
    
    .toml-content {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      color: var(--text);
      overflow-x: auto;
    }
    
    .toml-content .key {
      color: #0969da;
      font-weight: 600;
    }
    
    .toml-content .string {
      color: #0a3069;
    }
    
    .toml-content .number {
      color: #0550ae;
    }
    
    .toml-content .boolean {
      color: #8250df;
    }
    
    .toml-content .comment {
      color: #6e7781;
      font-style: italic;
    }
    
    .toml-loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
  </style>

<!-- TOML Config Modal -->
<div id="toml-modal" class="modal" onclick="closeTomlConfig(event)">
  <div class="modal-card" data-size="lg">
    <div class="modal-header">
      <div class="modal-title">Training Configuration (TOML)</div>
      <button class="modal-close" type="button" aria-label="Close" onclick="closeTomlConfig(event)">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="toml-content" class="toml-loading">Loading configuration...</div>
    </div>
  </div>
</div>
