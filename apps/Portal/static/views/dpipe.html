<style>
  .dp-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
  .dp-row { display:flex; gap:10px; flex-wrap:wrap; }
  .dp-row .field { min-width: 120px; }
  .dp-card { padding:12px; }
  .dp-card h4 { margin-top:0; margin-bottom:10px; }
  .dp-log { max-height:300px; background:#0f172a; color:#e2e8f0; }
</style>

<h2>Train with dpipes</h2>
<div class="alert mb-12">
  <strong>Experimental:</strong> This integration is under active development. Expect rough edges and use at your own risk.
</div>

<div class="card">
  <div class="dp-grid">
    <div class="panel dp-card stack-sm">
      <h4>Paths</h4>
      <div class="field"><label>Dataset Path</label><input id="dp-dataset" class="input" type="text" value="/workspace/datasets" /></div>
      <div class="field"><label>Config Path</label><input id="dp-config" class="input" type="text" value="/workspace/configs" /></div>
      <div class="field"><label>Output Path</label><input id="dp-output" class="input" type="text" value="/workspace/outputs" /></div>
    </div>

    <div class="panel dp-card stack-sm">
      <h4>Model Paths</h4>
      <div class="field"><label>Transformer</label><input id="dp-transformer" class="input" type="text" value="/workspace/models/hunyuan_video_720_cfgdistill_fp8_e4m3fn.safetensors" /></div>
      <div class="field"><label>VAE</label><input id="dp-vae" class="input" type="text" value="/workspace/models/hunyuan_video_vae_fp32.safetensors" /></div>
      <div class="field"><label>LLM</label><input id="dp-llm" class="input" type="text" value="/workspace/models/llava-llama-3-8b-text-encoder-tokenizer" /></div>
      <div class="field"><label>CLIP</label><input id="dp-clip" class="input" type="text" value="/workspace/models/clip-vit-large-patch14" /></div>
    </div>
  </div>

  <div class="dp-grid mt-12">
    <div class="panel dp-card">
      <h4>Training</h4>
      <div class="dp-row">
        <div class="field"><label>Epochs</label><input id="dp-epochs" class="input" type="number" value="1000" /></div>
        <div class="field"><label>Batch</label><input id="dp-batch" class="input" type="number" value="1" /></div>
        <div class="field"><label>LR</label><input id="dp-lr" class="input" type="number" step="0.00001" value="0.00002" /></div>
        <div class="field"><label>GAS</label><input id="dp-gas" class="input" type="number" value="4" /></div>
        <div class="field"><label>Rank</label><input id="dp-rank" class="input" type="number" value="32" /></div>
        <div class="field"><label>LoRA dtype</label>
          <select id="dp-dtype" class="select">
            <option value="bfloat16" selected>bfloat16</option>
            <option value="float16">float16</option>
            <option value="float32">float32</option>
            <option value="float8">float8</option>
          </select>
        </div>
      </div>
      <div class="dp-row mt-8">
        <div class="field"><label>Save every (epochs)</label><input id="dp-save-every" class="input" type="number" value="2" /></div>
        <div class="field"><label>Eval every (epochs)</label><input id="dp-eval-every" class="input" type="number" value="1" /></div>
        <div class="field"><label>Checkpoint mins</label><input id="dp-ckpt-mins" class="input" type="number" value="120" /></div>
        <div class="field"><label>Warmup steps</label><input id="dp-warmup" class="input" type="number" value="100" /></div>
        <div class="field"><label>Grad clip</label><input id="dp-gradclip" class="input" type="number" step="0.1" value="1.0" /></div>
        <div class="field"><label>Steps/print</label><input id="dp-steps-print" class="input" type="number" value="1" /></div>
      </div>
    </div>

    <div class="panel dp-card stack-sm">
      <h4>Dataset</h4>
      <div class="field"><label>Resolutions JSON</label><input id="dp-res" class="input" type="text" value="[512]" /></div>
      <div class="field"><label>Frame buckets</label><input id="dp-frames" class="input" type="text" value="[1,33]" /></div>
      <div class="field"><label>AR buckets</label><input id="dp-ar" class="input" type="text" value="" placeholder="optional JSON list" /></div>
      <div class="field"><label>Num repeats</label><input id="dp-repeats" class="input" type="number" value="10" /></div>
      <label class="status status-check"><input type="checkbox" id="dp-resume" /> Resume from last checkpoint</label>
      <label class="status status-check"><input type="checkbox" id="dp-double" /> Train only double blocks</label>
    </div>

    <div class="panel dp-card stack-sm">
      <h4>Optimizer</h4>
      <div class="field">
        <label>Optimizer</label>
        <select id="dp-optim" class="select">
          <option value="adamw_optimi" selected>adamw_optimi</option>
          <option value="adamw">adamw</option>
          <option value="adamw8bit">adamw8bit</option>
          <option value="stableadamw">stableadamw</option>
          <option value="sgd">sgd</option>
          <option value="adamw8bitKahan">adamw8bitKahan</option>
          <option value="offload">offload</option>
        </select>
      </div>
      <div class="field"><label>Betas</label><input id="dp-betas" class="input" type="text" value="[0.9,0.99]" /></div>
      <div class="dp-row">
        <div class="field"><label>Weight Decay</label><input id="dp-wd" class="input" type="number" step="0.0001" value="0.01" /></div>
        <div class="field"><label>Eps</label><input id="dp-eps" class="input" type="number" step="0.0000001" value="0.00000001" /></div>
      </div>
    </div>

    <div class="panel dp-card stack-sm">
      <h4>Evaluation & Misc</h4>
      <div class="dp-row">
        <div class="field"><label>Video clip mode</label><input id="dp-vmode" class="input" type="text" value="single_middle" /></div>
        <div class="field"><label>Eval MB/GPU</label><input id="dp-eval-mb" class="input" type="number" value="1" /></div>
        <div class="field"><label>Eval GAS</label><input id="dp-eval-gas" class="input" type="number" value="1" /></div>
      </div>
      <label class="status status-check"><input type="checkbox" id="dp-enable-wandb" /> Enable Wandb</label>
      <input id="dp-wandb-name" class="input is-hidden" type="text" placeholder="wandb run name" />
      <input id="dp-wandb-proj" class="input is-hidden" type="text" placeholder="wandb tracker name" />
      <input id="dp-wandb-key" class="input is-hidden" type="text" placeholder="wandb api key" />
    </div>
  </div>

  <div class="row wrap mt-14">
    <button class="btn primary" onclick="startDpipe()">Start Training</button>
    <button class="btn danger" onclick="stopDpipe()">Stop</button>
    <span id="dp-status" class="status"></span>
  </div>
  <div class="panel mt-12">
    <h3>Logs</h3>
    <pre id="dp-logs" class="log-box mono dp-log"></pre>
  </div>
</div>
