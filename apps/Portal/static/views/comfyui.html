<style>
  .logo-light { display:block; }
  .logo-dark { display:none; }
  :root[data-theme="dark"] .logo-light { display:none !important; }
  :root[data-theme="dark"] .logo-dark { display:block !important; }
  :root[data-theme="light"] .logo-light { display:block !important; }
  :root[data-theme="light"] .logo-dark { display:none !important; }
  
  .comfy-container {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 16px;
    height: calc(100vh - 120px);
  }
  
  .comfy-iframe {
    width: 100%;
    height: 100%;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
  }
  
  .preview-panel {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .preview-container {
    flex: 1;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    position: relative;
  }
  
  .preview-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 4px;
  }
  
  .preview-placeholder {
    color: var(--muted);
    font-size: 14px;
    text-align: center;
  }
  
  .status-indicator {
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
  }
  
  .status-connected {
    background: var(--pill-ok);
    color: #16a34a;
  }
  
  .status-disconnected {
    background: var(--pill-miss);
    color: #dc2626;
  }
  
  .status-connecting {
    background: var(--pill);
    color: var(--text);
  }
  
  .preview-info {
    font-size: 12px;
    color: var(--muted);
    margin-top: 8px;
  }
  
  @media (max-width: 1024px) {
    .comfy-container {
      grid-template-columns: 1fr;
      height: auto;
    }
    
    .preview-panel {
      order: -1;
    }
    
    .comfy-iframe {
      height: 500px;
    }
  }
</style>

<div style="text-align:center; margin-bottom:12px;">
  <img src="/logo-comfyui.svg" alt="ComfyUI" class="logo-light" style="width:300px; height:auto; margin:0 auto; display:block;">
  <img src="/logodark-comfyui.svg" alt="ComfyUI" class="logo-dark" style="width:300px; height:auto; margin:0 auto; display:block;">
</div>

<h2 style="margin-top:0;">ComfyUI with Live Preview</h2>

<div class="card">
  <div class="comfy-container">
    <!-- ComfyUI iframe -->
    <div>
      <iframe 
        id="comfy-iframe"
        class="comfy-iframe"
        src="about:blank"
        title="ComfyUI Interface">
      </iframe>
    </div>
    
    <!-- Live preview panel -->
    <div class="preview-panel">
      <div class="card">
        <h4 style="margin: 0 0 12px 0;">Live Preview</h4>
        
        <!-- Connection status -->
        <div id="connection-status" class="status-indicator status-connecting">
          Connecting to ComfyUI...
        </div>
        
        <!-- Preview container -->
        <div class="preview-container" id="preview-container">
          <div class="preview-placeholder">
            Waiting for images...
          </div>
        </div>
        
        <!-- Preview info -->
        <div id="preview-info" class="preview-info" style="display: none;">
          <div>Dimensions: <span id="preview-dimensions">-</span></div>
          <div>Generated: <span id="preview-time">-</span></div>
        </div>
      </div>
      
      <!-- Controls -->
      <div class="card">
        <h4 style="margin: 0 0 12px 0;">Controls</h4>
        <button id="preview-toggle" style="width: 100%; margin-bottom: 8px;">
          Pause Preview
        </button>
        <button id="clear-preview" style="width: 100%;">
          Clear Preview
        </button>
      </div>
      
      <!-- ComfyUI status -->
      <div class="card">
        <h4 style="margin: 0 0 12px 0;">ComfyUI Status</h4>
        <div id="comfy-status" class="status-indicator status-connecting">
          Checking status...
        </div>
        <div style="margin-top: 8px; font-size: 13px;">
          <div>Port: <span id="comfy-port">5555</span></div>
          <div>Images: <span id="image-count">0</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let comfyWebSocket = null;
let previewEnabled = true;
let imageCount = 0;
let lastGeneratedImage = null;

// Initialize ComfyUI connection
function initComfyUI() {
  updateConnectionStatus('connecting', 'Connecting to ComfyUI...');
  checkComfyUIStatus();
  connectWebSocket();
  // Load last generated image after a short delay
  setTimeout(loadLastGeneratedImage, 2000);
}

// Check ComfyUI status
async function checkComfyUIStatus() {
  try {
    const response = await fetch('/api/comfy/status');
    const status = await response.json();
    
    const statusEl = document.getElementById('comfy-status');
    const portEl = document.getElementById('comfy-port');
    const iframeEl = document.getElementById('comfy-iframe');
    
    if (status.status === 'running') {
      statusEl.className = 'status-indicator status-connected';
      statusEl.textContent = 'Running';
      portEl.textContent = status.port;
      // Set iframe src when ComfyUI is running - detect deployment type
      if (!iframeEl.src || iframeEl.src === 'about:blank') {
        iframeEl.src = getComfyUIUrl(status.port);
      }
    } else {
      statusEl.className = 'status-indicator status-disconnected';
      statusEl.textContent = 'Stopped';
      portEl.textContent = status.port || '5555';
      iframeEl.src = 'about:blank';
    }
  } catch (error) {
    const statusEl = document.getElementById('comfy-status');
    statusEl.className = 'status-indicator status-disconnected';
    statusEl.textContent = 'Error';
  }
}

// Get ComfyUI URL based on deployment type
function getComfyUIUrl(port) {
  const currentHost = window.location.host;
  
  // Check if we're on RunPod (contains .proxy.runpod.net)
  if (currentHost.includes('.proxy.runpod.net')) {
    // Extract the base hostname (before first dash) and construct ComfyUI subdomain
    const baseHost = currentHost.split('-')[0]; // Get part before first dash
    return `https://${baseHost}-${port}.proxy.runpod.net/`;
  } else {
    // Local deployment - use current host with port
    const protocol = window.location.protocol;
    return `${protocol}//${window.location.hostname}:${port}/`;
  }
}

// Load last generated image from ComfyUI outputs
async function loadLastGeneratedImage() {
  try {
    // Try to get the latest image from ComfyUI output directory
    const response = await fetch('/api/comfy/latest-image');
    if (response.ok) {
      const data = await response.json();
      if (data.image) {
        displayLastImage(data.image);
      }
    }
  } catch (error) {
    console.log('Could not load last image:', error);
    // Fallback: show placeholder
    if (!lastGeneratedImage) {
      showPlaceholder('No images generated yet');
    }
  }
}

// Display last generated image
function displayLastImage(imageInfo) {
  const container = document.getElementById('preview-container');
  const infoEl = document.getElementById('preview-info');
  const dimensionsEl = document.getElementById('preview-dimensions');
  const timeEl = document.getElementById('preview-time');
  
  lastGeneratedImage = imageInfo;
  
  // Create image element
  const img = document.createElement('img');
  img.className = 'preview-image';
  
  // Convert the URL based on deployment type
  if (imageInfo.url.startsWith('/proxy/comfy/view')) {
    // Extract filename from the proxy URL
    const filename = imageInfo.url.split('filename=')[1];
    img.src = getComfyUIImageUrl(filename);
  } else {
    // Use the URL as-is
    img.src = imageInfo.url;
  }
  
  // Update info
  dimensionsEl.textContent = imageInfo.dimensions || '-';
  timeEl.textContent = imageInfo.generated_at ? new Date(imageInfo.generated_at).toLocaleTimeString() : '-';
  
  // Clear container and show image
  container.innerHTML = '';
  container.appendChild(img);
  infoEl.style.display = 'block';
}

// Show placeholder message
function showPlaceholder(message) {
  const container = document.getElementById('preview-container');
  const infoEl = document.getElementById('preview-info');
  
  container.innerHTML = `<div class="preview-placeholder">${message}</div>`;
  infoEl.style.display = 'none';
}

// Connect to WebSocket for live preview
function connectWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}/ws/comfy`;
  
  try {
    comfyWebSocket = new WebSocket(wsUrl);
    
    comfyWebSocket.onopen = function() {
      updateConnectionStatus('connected', 'Connected to ComfyUI');
    };
    
    comfyWebSocket.onmessage = function(event) {
      if (!previewEnabled) return;
      
      try {
        const data = JSON.parse(event.data);
        
        // Handle different message types from ComfyUI
        if (data.type === 'executed' && data.data?.node) {
          // Look for image outputs in executed node
          for (const nodeId in data.data.node) {
            const nodeOutputs = data.data.node[nodeId];
            if (nodeOutputs.images && nodeOutputs.images.length > 0) {
              const image = nodeOutputs.images[0];
              displayImage(image);
            }
          }
        } else if (data.type === 'progress') {
          // Handle progress updates if needed
          console.log('ComfyUI progress:', data.data);
        }
      } catch (error) {
        console.error('Error parsing WebSocket message:', error);
      }
    };
    
    comfyWebSocket.onclose = function() {
      updateConnectionStatus('disconnected', 'Disconnected from ComfyUI');
      // Try to reconnect after 3 seconds
      setTimeout(connectWebSocket, 3000);
    };
    
    comfyWebSocket.onerror = function(error) {
      updateConnectionStatus('disconnected', 'Connection error');
      console.error('WebSocket error:', error);
    };
    
  } catch (error) {
    updateConnectionStatus('disconnected', 'Failed to connect');
    console.error('Failed to create WebSocket:', error);
  }
}

// Update connection status display
function updateConnectionStatus(status, message) {
  const statusEl = document.getElementById('connection-status');
  statusEl.className = `status-indicator status-${status}`;
  statusEl.textContent = message;
}

// Display image in preview
function displayImage(imageData) {
  const container = document.getElementById('preview-container');
  const infoEl = document.getElementById('preview-info');
  const dimensionsEl = document.getElementById('preview-dimensions');
  const timeEl = document.getElementById('preview-time');
  const countEl = document.getElementById('image-count');
  
  // Create image element
  const img = document.createElement('img');
  img.className = 'preview-image';
  
  // Handle different image formats - detect deployment type
  if (imageData.filename) {
    img.src = getComfyUIImageUrl(imageData.filename);
    if (imageData.size) {
      dimensionsEl.textContent = `${imageData.size[0]}x${imageData.size[1]}`;
    }
  } else if (imageData.url) {
    // If it's a direct URL
    img.src = imageData.url;
  }
  
  // Update info
  const now = new Date();
  timeEl.textContent = now.toLocaleTimeString();
  imageCount++;
  countEl.textContent = imageCount;
  
  // Clear container and show image
  container.innerHTML = '';
  container.appendChild(img);
  infoEl.style.display = 'block';
  
  // Store as last generated image
  lastGeneratedImage = {
    url: img.src,
    dimensions: dimensionsEl.textContent,
    generated_at: now.toISOString()
  };
}

// Get ComfyUI image URL based on deployment type
function getComfyUIImageUrl(filename) {
  const currentHost = window.location.host;
  
  // Check if we're on RunPod (contains .proxy.runpod.net)
  if (currentHost.includes('.proxy.runpod.net')) {
    // Extract the base hostname (before first dash) and construct ComfyUI subdomain
    const baseHost = currentHost.split('-')[0]; // Get part before first dash
    const comfyHost = `${baseHost}-5555.proxy.runpod.net`;
    return `https://${comfyHost}/view?filename=${filename}`;
  } else {
    // Local deployment - use current host with port
    const protocol = window.location.protocol;
    return `${protocol}//${window.location.hostname}:5555/view?filename=${filename}`;
  }
}

// Toggle preview on/off
function togglePreview() {
  previewEnabled = !previewEnabled;
  const toggleBtn = document.getElementById('preview-toggle');
  toggleBtn.textContent = previewEnabled ? 'Pause Preview' : 'Resume Preview';
  
  if (!previewEnabled) {
    clearPreview();
  } else if (lastGeneratedImage) {
    // Show last image when resuming
    displayLastImage(lastGeneratedImage);
  }
}

// Clear preview
function clearPreview() {
  const container = document.getElementById('preview-container');
  container.innerHTML = '<div class="preview-placeholder">Preview paused</div>';
  
  const infoEl = document.getElementById('preview-info');
  infoEl.style.display = 'none';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  initComfyUI();
  
  // Check ComfyUI status every 10 seconds
  setInterval(checkComfyUIStatus, 10000);
});
</script>
